<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <link rel="stylesheet" href="/dashboard.css">
</head>

<body>
  <div class="app">
    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
      <a href="/users/dashboard" class="dashboard-title">
        <h2>Dashboard</h2>
      <a href="/users/profile">ğŸ‘¤ Profile</a>
      <a href="/users/orders/history">ğŸ›’ My Orders</a>
      <% if (currentUser && currentUser.role === "admin") { %>
        <h3>Admin Tools</h3>
        <a href="/users/admin/products/add">â• Add Product</a>
        <a href="/users/admin/products">ğŸ“¦ Manage Products</a>
        <a href="/users/admin/users">ğŸ‘¥ Manage Users</a>
        <a href="/users/admin/reactivation-requests">ğŸ”” Reactivation Requests</a>
        <a href="/users/admin/qr-codes">ğŸ“± Manage QR Codes</a>
        <a href="/admin/reports/sales">ğŸ“Š Sales Reports</a>
      <% } %>
      <a href="/users/logout">ğŸšª Logout</a>
    </div>

    <!-- Menu Toggle Button -->
    <button id="menuToggle" class="menu-toggle">â˜° Menu</button>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
      <div class="container">
        <h1>Welcome, <%= currentUser ? currentUser.firstName : 'Guest' %> ğŸ‘‹</h1>
        <p class="lead">Browse available products below</p>

<!-- ================================ -->
<!-- ORDER SUMMARY SECTION - ONLY FOR CUSTOMERS -->
<!-- ================================ -->
<% if (currentUser && currentUser.role !== "admin") { %>
  <section class="order-summary-section">
    <h2>ğŸ“Š Order Summary</h2>
    <p>Total Orders: <strong><%= totalOrders %></strong></p>

    <div class="status-grid">
      <div class="status-card pending">
        <h3>Pending Payment</h3>
        <div class="count"><%= statusCounts.pending %></div>
      </div>
      <div class="status-card paid">
        <h3>Paid / To Ship</h3>
        <div class="count"><%= statusCounts.paid %></div>
      </div>
      <div class="status-card shipped">
        <h3>Shipped</h3>
        <div class="count"><%= statusCounts.shipped %></div>
      </div>
      <div class="status-card completed">
        <h3>Completed</h3>
        <div class="count"><%= statusCounts.completed %></div>
      </div>
      <div class="status-card refund">
        <h3>Return/Refund</h3>
        <div class="count"><%= statusCounts.refund %></div>
      </div>
      <div class="status-card cancelled">
        <h3>Cancelled</h3>
        <div class="count"><%= statusCounts.cancelled %></div>
      </div>
    </div>
  </section>
<% } %>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search product name..."
          />
          <select id="categoryFilter">
            <option value="">All Categories</option>
            <% 
              const categories = [...new Set(products.map(p => p.category || "General"))];
              categories.forEach(c => { 
            %>
              <option value="<%= c %>"><%= c %></option>
            <% }) %>
          </select>
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="available">Available</option>
            <option value="unavailable">Unavailable</option>
            <option value="maintenance">Maintenance</option>
          </select>
        </div>

        <!-- Product Grid -->
        <div class="product-grid">
          <% if (products && products.length > 0) { %>
            <% products.forEach(p => { %>
              <div class="product-card">
                <img 
                  src="<%= 
                    (p.images && p.images[0]) 
                      ? p.images[0] 
                      : (p.imageUrl ? p.imageUrl : '/placeholder.png') 
                  %>" 
                  alt="product image" 
                />
                <div class="product-meta">
                  <div>
                    <span class="category-text"><%= p.category || 'General' %></span>
                  </div>
                  <div>
                    <span class="price">â‚±<%= (p.price || 0).toFixed(2) %></span>
                  </div>
                </div>
                <h3><%= p.name %></h3>
                <p class="desc">
                  <%= p.description ? (p.description.length > 100 ? p.description.substring(0,100) + 'â€¦' : p.description) : 'No description available' %>
                </p>
                <div class="stock-info">
                  <div>
                    Stock: <strong><%= typeof p.stock === 'number' ? p.stock : 'â€”' %></strong>
                  </div>
                  <div>
                    <% if (p.status) { %>
                      <span class="status-badge 
                        <% if (p.status === 'available') { %> status-available 
                        <% } else if (p.status === 'unavailable') { %> status-unavailable 
                        <% } else if (p.status === 'maintenance') { %> status-maintenance 
                        <% } %>">
                        <%= p.status %>
                      </span>
                    <% } %>
                  </div>
                </div>
                <div class="product-actions">
                  <a class="btn btn-primary" href="/products/view/<%= p._id %>">ğŸ” View</a>
                  <% if (currentUser && (currentUser.role === 'customer' || currentUser.role === 'user')) { %>
                    <% if (p.stock && p.stock > 0 && p.status === 'available') { %>
                      <a class="btn btn-success" href="/cart/add/<%= p._id %>">ğŸ›’ Add to Cart</a>
                    <% } else { %>
                      <span class="btn btn-disabled">Out of stock</span>
                    <% } %>
                  <% } %>
                  <% if (currentUser && currentUser.role === 'admin') { %>
                    <a class="btn btn-secondary" href="/users/admin/products/edit/<%= p._id %>">âœ Edit</a>
                    <a class="btn btn-danger" href="/users/admin/products/delete/<%= p._id %>">ğŸ—‘ Delete</a>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="empty-state">
              <p>No products available.</p>
              <a href="/users/admin/products/add" class="btn btn-primary">â• Add First Product</a>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

<script>
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  const mainContent = document.getElementById('mainContent');

  function updateTogglePosition() {
    if (sidebar.classList.contains('hidden')) {
      menuToggle.classList.add('shift-left');
      mainContent.style.marginLeft = '0';
      mainContent.style.width = '100%';
    } else {
      menuToggle.classList.remove('shift-left');
      mainContent.style.marginLeft = '250px';
      mainContent.style.width = 'calc(100% - 250px)';
    }
  }

  function toggleMenu() {
    sidebar.classList.toggle('hidden');
    updateTogglePosition();
  }

  menuToggle.addEventListener('click', toggleMenu);
  
  // Initialize positions
  updateTogglePosition();

  // Filter functionality
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");
  const statusFilter = document.getElementById("statusFilter");
  const cards = document.querySelectorAll(".product-card");

  function applyFilters() {
    const search = searchInput.value.toLowerCase();
    const category = categoryFilter.value;
    const status = statusFilter.value.toLowerCase();

    cards.forEach(card => {
      const name = card.querySelector("h3").innerText.toLowerCase();
      const cat = card.querySelector(".category-text").innerText.trim();
      const stat = card.querySelector(".status-badge")?.innerText.trim().toLowerCase();

      let match = true;

      if (search && !name.includes(search)) match = false;
      if (category && category !== cat) match = false;
      if (status && status !== stat) match = false;

      card.style.display = match ? "" : "none";
    });
  }

  searchInput.addEventListener("input", applyFilters);
  categoryFilter.addEventListener("change", applyFilters);
  statusFilter.addEventListener("change", applyFilters);
</script>
</body>
</html>