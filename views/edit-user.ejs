<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %></title>
    <link rel="stylesheet" href="/edit-user.css">


</head>

<body>

<div class="profile-container">
  <!-- Home button outside container -->
  <div class="back-btn">
    <a href="/users/dashboard" class="btn btn-primary">üè† Home</a>
  </div>

  <div class="container">
    <h2>üìù Edit Profile</h2>

    <!-- Success/Error Messages -->
    <% if (typeof alert !== 'undefined') { %>
      <div class="alert alert-success">
        <%= alert %>
      </div>
    <% } %>

    <a href="/users/profile" class="btn btn-secondary">‚Üê Back to Profile</a>

    <!-- PROFILE UPDATE FORM -->
    <form action="/users/edit-user/<%= user.userId %>" method="POST" enctype="multipart/form-data">

      <!-- AVATAR -->
      <div class="avatar-box">
        <% const avatar = user.profileImage || "/uploads/default-avatar.png"; %>
        <img src="<%= avatar %>" id="avatarPreview" class="avatar-preview" />
        <div>
          <input type="file" name="avatar" id="avatarInput" accept="image/*" class="file-input" />
          <p class="file-info">Max 5MB ‚Ä¢ JPG / PNG / GIF</p>
        </div>
      </div>

      <!-- PERSONAL INFO -->
      <label>First Name</label>
      <input type="text" name="firstName" value="<%= user.firstName %>" placeholder="Enter first name" required>

      <label>Last Name</label>
      <input type="text" name="lastName" value="<%= user.lastName %>" placeholder="Enter last name" required>

      <label>Email</label>
      <input type="email" value="<%= user.email %>" readonly placeholder="Email address">

      <!-- ADDRESS -->
      <h3 class="sub-section-title">üìç Address Information</h3>

      <label>Full Address</label>
      <input type="text" name="address" value="<%= user.address || '' %>" placeholder="Street address">

      <label>Province</label>
      <input type="text" name="province" value="<%= user.province || '' %>" placeholder="Province/State">

      <label>City</label>
      <input type="text" name="city" value="<%= user.city || '' %>" placeholder="City">

      <label>ZIP Code</label>
      <input type="text" name="zip" value="<%= user.zip || '' %>" placeholder="Postal/ZIP code">

      <label>Phone Number</label>
      <input type="text" name="phone" value="<%= user.phone || '' %>" placeholder="Phone number">

      <button type="submit">Save Profile</button>
    </form>

      <!-- PASSWORD SECTION -->
      <h3 class="sub-section-title">üîê Change Password</h3>

      <form action="/users/change-password/<%= user.userId %>" method="POST" id="passwordForm">

        <label>Old Password</label>
        <input type="password" name="oldPassword" id="oldPassword" placeholder="Enter current password" required>

        <label>New Password</label>
        <input type="password" name="newPassword" id="newPassword" placeholder="Enter new password" required>
        <div class="password-strength" id="passwordStrength">
          Password must be at least 8 characters long
        </div>

        <label>Confirm New Password</label>
        <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Confirm new password" required>
        <div class="password-match" id="passwordMatch"></div>

        <button type="submit" class="btn-secondary" style="width: 100%; margin-top: 10px;">
          Update Password
        </button>
      </form>
  </div>
</div>

<script>
  // Avatar preview
  const fileInput = document.getElementById("avatarInput");
  const preview = document.getElementById("avatarPreview");

  fileInput?.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;
    
    // Check file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB');
      fileInput.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = e => preview.src = e.target.result;
    reader.readAsDataURL(file);
  });

  // Password validation
  const passwordForm = document.getElementById('passwordForm');
  const newPassword = document.getElementById('newPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  const passwordStrength = document.getElementById('passwordStrength');
  const passwordMatch = document.getElementById('passwordMatch');

  function validatePassword() {
    const password = newPassword.value;
    
    // Check length
    if (password.length >= 8) {
      passwordStrength.textContent = '‚úì Password length is good';
      passwordStrength.className = 'password-strength valid';
    } else {
      passwordStrength.textContent = 'Password must be at least 8 characters long';
      passwordStrength.className = 'password-strength invalid';
    }
    
    validatePasswordMatch();
  }

  function validatePasswordMatch() {
    const confirm = confirmPassword.value;
    const password = newPassword.value;
    
    if (confirm === '') {
      passwordMatch.textContent = '';
      passwordMatch.className = 'password-match';
      return;
    }
    
    if (confirm === password) {
      passwordMatch.textContent = '‚úì Passwords match';
      passwordMatch.className = 'password-match valid';
    } else {
      passwordMatch.textContent = '‚úó Passwords do not match';
      passwordMatch.className = 'password-match invalid';
    }
  }

  function validateForm() {
    const password = newPassword.value;
    const confirm = confirmPassword.value;
    const oldPass = document.getElementById('oldPassword').value;
    
    if (!oldPass) {
      alert('Please enter your current password');
      return false;
    }
    
    if (password.length < 8) {
      alert('Password must be at least 8 characters long');
      return false;
    }
    
    if (password !== confirm) {
      alert('Passwords do not match');
      return false;
    }
    
    return true;
  }

  // Event listeners
  newPassword.addEventListener('input', validatePassword);
  confirmPassword.addEventListener('input', validatePasswordMatch);
  
  passwordForm.addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
    }
  });
</script>

</body>
</html>