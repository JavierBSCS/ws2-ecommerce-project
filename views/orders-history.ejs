<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link rel="stylesheet" href="/orders-history.css">
  <link rel="stylesheet" href="/shared.css">
</head>

<body>
  <div class="app">
    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
      <a href="/users/dashboard" class="dashboard-title">
        <h2>Dashboard</h2>
      </a>
      <a href="/users/profile">ğŸ‘¤ Profile</a>
      <a href="/users/orders/history" class="active">ğŸ›’ My Orders</a>
      <% if (currentUser && currentUser.role === "admin") { %>
        <h3>Admin Tools</h3>
        <a href="/users/admin/products/add">â• Add Product</a>
        <a href="/users/admin/products">ğŸ“¦ Manage Products</a>
        <a href="/users/admin/users">ğŸ‘¥ Manage Users</a>
        <a href="/users/admin/reactivation-requests">ğŸ”” Reactivation Requests</a>
        <a href="/users/admin/qr-codes">ğŸ“± Manage QR Codes</a>
        <a href="/admin/reports/sales">ğŸ“Š Sales Reports</a>
      <% } %>
      <a href="/users/logout">ğŸšª Logout</a>
    </div>

    <!-- Menu Toggle Button -->
    <button id="menuToggle" class="menu-toggle">â˜° Menu</button>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
      <div class="profile-container">
        <div class="container">
          <!-- Conditional Back Link -->
          <% if (currentUser.role === 'admin') { %>
            <a href="javascript:history.back()" class="back">Go Back</a>
          <% } else { %>
            <a href="/users/dashboard" class="back">â† Back to Dashboard</a>
          <% } %>
          
          <h1>
            <% if (currentUser.role === 'admin') { %>
              ğŸ“¦ All Customer Orders
            <% } else { %>
              ğŸ“¦ My Orders
            <% } %>
          </h1>

          <% if (!orders.length) { %>
            <div class="empty-state">
              <p>
                <% if (currentUser.role === 'admin') { %>
                  No orders found from customers.
                <% } else { %>
                  You have not placed any orders yet.
                <% } %>
              </p>
              <a href="/users/dashboard" class="btn btn-primary">ğŸ›ï¸ Start Shopping</a>
            </div>
          <% } else { %>

          <table>
            <thead>
              <tr>
                <% if (currentUser.role === 'admin') { %>
                  <th>Customer</th>
                <% } %>
                <th>Order ID</th>
                <th>Order Name</th>
                <th>Total</th>
                <th>Payment Method</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% orders.forEach(o => { %>
                <tr>
                  <!-- CUSTOMER COLUMN (Admin Only) -->
                  <% if (currentUser.role === 'admin') { %>
                    <td>
                      <div class="customer-info">
                        <div class="customer-name">
                          ğŸ‘¤ <%= o.customerName || 'Loading...' %>
                        </div>
                        <% if (o.customerEmail) { %>
                          <div class="customer-email">
                            ğŸ“§ <%= o.customerEmail %>
                          </div>
                        <% } %>
                        <div class="customer-id">
                          ID: <%= o.userId %>
                        </div>
                      </div>
                    </td>
                  <% } %>

                  <!-- ORDER ID -->
                  <td>
                    <span class="order-id">
                      <%= o.orderId %>
                    </span>
                  </td>

                  <!-- ORDER NAME -->
                  <td>
                    <span class="order-name">
                      <% 
                        const firstItem = o.items[0];
                        const extra = o.items.length - 1;
                        const orderName = extra > 0 
                          ? `${firstItem.name} and ${extra} more`
                          : firstItem.name;
                      %>
                      <%= orderName %>
                    </span>
                  </td>

                  <!-- TOTAL -->
                  <td>
                    <span class="order-total">
                      â‚±<%= (o.totalAmount || o.subtotal || 0).toFixed(2) %>
                    </span>
                  </td>

                  <!-- PAYMENT METHOD -->
                  <td>
                    <span class="payment-method <%= o.paymentMethod?.toLowerCase() || 'cash' %>">
                      <% if (o.paymentMethod === 'gcash') { %>
                        ğŸ“± GCash
                      <% } else { %>
                        ğŸ’µ Cash on Delivery
                      <% } %>
                    </span>
                  </td>

                  <!-- STATUS -->
                  <td>
                    <span class="status <%= o.orderStatus %>">
                      <%= o.orderStatus.replace("_", " ").toUpperCase() %>
                    </span>
                  </td>

                  <!-- DATE -->
                  <td>
                    <span class="order-date">
                      <% 
                        const date = new Date(o.createdAt);
                        const formattedDate = date.toLocaleString("en-US", {
                          month: "2-digit",
                          day: "2-digit",
                          year: "numeric",
                          hour: "2-digit",
                          minute: "2-digit",
                          hour12: true
                        }).replace(",", "").replace(" AM", " AM").replace(" PM", " PM");
                      %>
                      <%= formattedDate %>
                    </span>
                  </td>

                  <!-- ACTIONS -->
                  <td>
                    <div class="actions-cell">
                      <!-- VIEW BUTTON - Always show this for everyone -->
                      <a href="/orders/view/<%= o.orderId %>" class="btn-view">
                        ğŸ‘ï¸ View
                      </a>

                      <!-- CANCEL BUTTON - Show only for customers with "pending" status -->
                      <% if (currentUser.role !== 'admin' && o.orderStatus === "pending") { %>
                        <form action="/orders/cancel/<%= o.orderId %>" method="POST" style="display:inline;">
                          <button type="submit" class="btn-danger" 
                                  onclick="return confirm('Are you sure you want to cancel this order?')">
                            Cancel
                          </button>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar JavaScript -->
  <script>
    // Shared sidebar functionality
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    const mainContent = document.getElementById('mainContent');

    console.log('Sidebar elements check:', {
      sidebar: sidebar ? 'Found' : 'Missing',
      menuToggle: menuToggle ? 'Found' : 'Missing',
      mainContent: mainContent ? 'Found' : 'Missing'
    });

    function updateTogglePosition() {
      if (sidebar.classList.contains('hidden')) {
        menuToggle.classList.add('shift-left');
        menuToggle.textContent = 'â˜° Show Menu';
        if (mainContent) {
          mainContent.style.marginLeft = '0';
          mainContent.style.width = '100%';
        }
      } else {
        menuToggle.classList.remove('shift-left');
        menuToggle.textContent = 'â˜° Hide Menu';
        if (mainContent) {
          mainContent.style.marginLeft = '250px';
          mainContent.style.width = 'calc(100% - 250px)';
        }
      }
    }

    function toggleMenu() {
      sidebar.classList.toggle('hidden');
      updateTogglePosition();
      
      // Save sidebar state in localStorage
      const isHidden = sidebar.classList.contains('hidden');
      localStorage.setItem('sidebarHidden', isHidden);
      
      console.log('Menu toggled. Hidden:', isHidden);
    }

    menuToggle.addEventListener('click', toggleMenu);
    
    // Initialize positions and load saved state
    function initializeSidebar() {
      const savedState = localStorage.getItem('sidebarHidden');
      if (savedState === 'true') {
        sidebar.classList.add('hidden');
      }
      updateTogglePosition();
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeSidebar);
  </script>
</body>
</html>